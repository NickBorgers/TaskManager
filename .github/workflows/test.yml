name: Run Tests

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test image
      run: docker build --target test -t notion-home-task-manager:test .

    - name: Run unit tests
      run: |
        docker run --rm \
          -v $(pwd)/htmlcov:/app/htmlcov \
          -v $(pwd)/coverage.xml:/app/coverage.xml \
          notion-home-task-manager:test \
          pytest tests/test_weekly_rollover.py tests/test_daily_planned_date_review.py tests/test_scheduler.py -v --cov=scripts --cov-report=term-missing

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: always()
      with:
        files: ./coverage.xml
        flags: unittests

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    # Run integration tests on main branch, tags, or PRs
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') || github.event_name == 'pull_request'
    # Ensure only one integration test runs at a time to prevent Notion API rate limiting
    # All integration tests share the same Notion workspace, so concurrent runs will exceed rate limits
    concurrency:
      group: notion-integration-tests
      cancel-in-progress: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r test_requirements.txt

    - name: Run integration tests
      env:
        NOTION_INTEGRATION_SECRET: ${{ secrets.NOTION_INTEGRATION_SECRET_TEST }}
      run: |
        # Integration tests include automatic rate limiting via conftest.py fixtures
        # to prevent hitting Notion's API limits (3 req/sec, 2700 calls per 15 min)
        pytest tests/test_integration_weekly_rollover.py tests/test_integration_daily_review.py -v --tb=short

    - name: Cleanup test data
      if: always()
      run: |
        echo "Integration tests completed - test data left in test databases for inspection"

  release-validation:
    name: Release Validation
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    # Only run on release tags
    if: startsWith(github.ref, 'refs/tags/v')
    # Share concurrency group with integration tests since both hit Notion API
    concurrency:
      group: notion-integration-tests
      cancel-in-progress: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r test_requirements.txt

    - name: Run release validation
      env:
        NOTION_INTEGRATION_SECRET: ${{ secrets.NOTION_INTEGRATION_SECRET_TEST }}
      run: |
        chmod +x scripts/validate_release.sh
        ./scripts/validate_release.sh

    - name: Upload validation logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: validation-logs
        path: /tmp/*test.log

